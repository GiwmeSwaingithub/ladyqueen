<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YouTube Player</title>
    <style>
        /* CRITICAL CSS - Inline for fastest render */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #000; height: 100vh; overflow: hidden; font-family: -apple-system, sans-serif; }
        #player-container, #player { width: 100%; height: 100%; position: relative; }
        .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: white; font-size: 16px; }
        .error { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: white; text-align: center; display: none; }
    </style>
    <!-- Preconnect to YouTube domains -->
    <link rel="preconnect" href="https://www.youtube.com">
    <link rel="preconnect" href="https://www.google.com">
    <link rel="dns-prefetch" href="https://www.youtube.com">
    <link rel="dns-prefetch" href="https://www.google.com">
</head>
<body>
    <!-- Minimal DOM for fastest rendering -->
    <div id="player-container">
        <div class="loading" id="loading">Loading...</div>
        <div id="player"></div>
        <div class="error" id="error">
            <div id="errorMessage"></div>
            <button id="retryBtn" style="display:none;margin-top:10px;padding:8px 16px;background:#ff0000;color:white;border:none;border-radius:4px;">Retry</button>
        </div>
    </div>

    <script>
        // IMMEDIATE EXECUTION - No DOMContentLoaded wait
        (function() {
            'use strict';
            
            // Fast URL parsing
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('v') || urlParams.get('videoId') || 'M7lc1UVf-VE';
            const autoplay = urlParams.get('autoplay') !== '0';
            
            // Fast DOM references
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const errorMsgEl = document.getElementById('errorMessage');
            const retryBtn = document.getElementById('retryBtn');
            
            let player = null;
            let isPlayerReady = false;
            
            // ULTRA-FAST YouTube API loading
            function loadYouTubeAPI() {
                // Inject script at highest priority
                const script = document.createElement('script');
                script.src = 'https://www.youtube.com/iframe_api';
                script.async = true;
                
                // Set global callback immediately (before script loads)
                window.onYouTubeIframeAPIReady = function() {
                    initializePlayer();
                };
                
                script.onerror = function() {
                    showError('Network Error', true);
                };
                
                // Inject at document start for fastest execution
                (document.head || document.documentElement).appendChild(script);
            }
            
            // Fast player initialization
            function initializePlayer() {
                try {
                    player = new window.YT.Player('player', {
                        width: '100%',
                        height: '100%',
                        videoId: videoId,
                        playerVars: {
                            'autoplay': autoplay ? 1 : 0,
                            'playsinline': 1,
                            'controls': 0,
                            'rel': 0,
                            'modestbranding': 1,
                            'fs': 0,
                            'iv_load_policy': 3,
                            'disablekb': 1,
                            'origin': window.location.origin
                        },
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange,
                            'onError': onPlayerError
                        }
                    });
                } catch (e) {
                    showError('Player Error', true);
                }
            }
            
            // Fast error handling
            function showError(message, retryable) {
                if (loadingEl) loadingEl.style.display = 'none';
                if (errorEl) errorEl.style.display = 'block';
                if (errorMsgEl) errorMsgEl.textContent = message;
                
                if (retryable && retryBtn) {
                    retryBtn.style.display = 'inline-block';
                    retryBtn.onclick = function() {
                        errorEl.style.display = 'none';
                        loadingEl.style.display = 'block';
                        loadYouTubeAPI();
                    };
                } else if (retryBtn) {
                    retryBtn.style.display = 'none';
                }
            }
            
            // Optimized event handlers
            function onPlayerReady(event) {
                isPlayerReady = true;
                if (loadingEl) loadingEl.style.display = 'none';
                
                // Minimal control hiding - just disable pointer events
                const iframe = document.querySelector('#player iframe');
                if (iframe) {
                    iframe.style.pointerEvents = 'none';
                }
                
                // Send minimal ready message
                if (window.parent) {
                    window.parent.postMessage({ type: 'READY', videoId: videoId }, '*');
                }
            }
            
            function onPlayerStateChange(event) {
                // Fast state handling
                if (event.data === 1 && errorEl) { // PLAYING
                    errorEl.style.display = 'none';
                }
                
                // Minimal message passing
                if (window.parent && isPlayerReady) {
                    window.parent.postMessage({ 
                        type: 'STATE', 
                        state: event.data,
                        time: event.target.getCurrentTime?.() || 0
                    }, '*');
                }
            }
            
            function onPlayerError(event) {
                let message = 'Playback Error';
                let retryable = true;
                
                switch(event.data) {
                    case 2: message = 'Invalid Video'; retryable = false; break;
                    case 100: message = 'Video Not Found'; retryable = false; break;
                    case 101: case 150: message = 'Embedding Not Allowed'; retryable = false; break;
                    case 5: message = 'Player Error'; break;
                }
                
                showError(message, retryable);
                
                if (window.parent) {
                    window.parent.postMessage({ type: 'ERROR', code: event.data }, '*');
                }
            }
            
            // Fast message handling
            window.addEventListener('message', function(e) {
                if (!player || !isPlayerReady) return;
                
                const msg = e.data;
                if (typeof msg === 'object') {
                    switch(msg.type) {
                        case 'PLAY': player.playVideo?.(); break;
                        case 'PAUSE': player.pauseVideo?.(); break;
                        case 'STOP': player.stopVideo?.(); break;
                        case 'SEEK': if (msg.time) player.seekTo?.(msg.time, true); break;
                        case 'LOAD': 
                            if (msg.videoId) {
                                loadingEl.style.display = 'block';
                                errorEl.style.display = 'none';
                                player.loadVideoById?.(msg.videoId);
                            }
                            break;
                    }
                }
            });
            
            // Fast initialization timeout
            setTimeout(function() {
                if (!isPlayerReady && loadingEl.style.display !== 'none') {
                    showError('Loading Timeout', true);
                }
            }, 8000);
            
            // START IMMEDIATELY - Begin loading API right away
            loadYouTubeAPI();
            
        })(); // Self-executing for immediate execution
        
        // Minimal touch blocking (only essential)
        document.addEventListener('touchstart', function(e) {
            if (e.target.tagName === 'BUTTON') return;
            e.preventDefault();
        }, { passive: false });
        
        // Prevent any context menus
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });
    </script>
</body>
</html>
